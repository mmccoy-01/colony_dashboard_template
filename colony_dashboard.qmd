---
title: "Mouse Colony"
author: "Michael McCoy"
logo: "https://yt3.googleusercontent.com/ytc/APkrFKbprBkcDrFaaYruHcnwzSgxUJV2N0799D788ar6dQ=s900-c-k-c0x00ffffff-no-rj"
nav-buttons:
- icon: github
  href: https://github.research.chop.edu/mmccoy-01?tab=repositories
- icon: linkedin
  href: https://www.linkedin.com/in/themichaelmccoy
format: 
  dashboard:
    orientation: columns
    theme:
      light: cerulean
      dark: darkly
---

```{r Setup}
#| context: setup

pkg_list <- c(
  "tidyverse", "DT"
)

# Function to install and load packages
load_packages <- function(pkg_list) {
  for (pkg in pkg_list) {
    if (!require(pkg, character.only = TRUE)) {
      install.packages(pkg, dependencies = TRUE)
      library(pkg, character.only = TRUE)
    }
  }
}

load_packages(pkg_list)

# library(knitr) # for kable table formatting
# library(tidyverse) # tidyverse
# library(shiny) # shiny app functionality
# library(DT) # for rendering tables
# library(scales) # scale functions for customizing visualizations
# library(plotly) # interactive cursor friendly plots
# library(survival) # for survival curves
# library(survminer) # for survival curves
# library(jmv) # performing statistical analyses

#setwd(dirname(rstudioapi::getSourceEditorContext()$path))
```

# Page

## Column

```{r Breeders}
#|title: "Breeders"

# Load data
raw_data <- read.csv("data/raw/raw_data.csv")

# Select the desired columns
raw_data <- raw_data %>% filter(status == "breeder")

# Create an interactive DataTable
datatable(raw_data)
```

```{r Litters}
#| title: "Litters"

# Load data
raw_data <- read.csv("data/raw/raw_data.csv") %>%
  filter(status == "breeder",
         weaned == ""
         )

# Calculate the difference in days between today's date and the `wean_date`
today <- Sys.Date()


# Convert `wean_date` to Date format and apply calculation
raw_data %>%
  mutate(wean_date = as.Date(wean_date, format = "%Y-%m-%d"),
         days_to_wean = as.numeric(wean_date - today),
         message = paste0("Cage ", cage_number, 
                          " has ", litter_size, 
                          " pups ready to be weaned in ", days_to_wean, 
                          " days on ", wean_date, ".")) %>%
  pull(message) %>%
  walk(cat, "\n")
```

## Column

```{r Weanlings}
#|title: "Breeders"

# Load data
raw_data <- read.csv("data/raw/raw_data.csv")

# Select the desired columns
raw_data <- raw_data %>% filter(status == "weanling")

# Create an interactive DataTable
datatable(raw_data)
```

```{r Colony Mice}
#| title: "Colony mice"

# Load data
raw_data <- read.csv("data/raw/raw_data.csv") %>%
  filter(status == "weanling")

# Calculate the difference in days between today's date and the `dob`
today <- Sys.Date()

# Convert `dob` to Date format and apply calculation
# Also, calculate the total number of mice and the count of each sex
# Convert `dob` to Date format and apply calculation
# Convert `dob` to Date format and apply calculation
raw_data %>%
  mutate(dob = as.Date(dob, format = "%Y-%m-%d"),
         days_old = as.numeric(today - dob)) %>%
  group_by(status, sex) %>%
  summarise(
    total_mice_by_sex = sum(num_of_mice_in_cage, na.rm = TRUE), 
    avg_days_old = mean(days_old, na.rm = TRUE),  # Calculate the average days old
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = sex, values_from = total_mice_by_sex, values_fill = 0) %>%
  mutate(
    total_mice = coalesce(female, 0) + coalesce(male, 0),
    avg_weeks_old = round(avg_days_old / 7, 1),  # Convert days to weeks and round to 1 decimal
    message = paste0("You have ", total_mice, 
                     " mice (", coalesce(female, 0), " female and ", 
                     coalesce(male, 0), " male) that are about ", avg_weeks_old, " weeks old.")
  ) %>%
  pull(message) %>%
  walk(cat, "\n")
```